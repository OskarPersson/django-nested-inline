(function(b){function k(d,a,e,n){var h=b(!1),p=d.replace(/[-][0-9][-]/g,"-0-");b("#"+p+"-group ."+p+"-nested-inline").not(".cloned").first().each(function(){var f=b(this).attr("id").split("-group")[0],g=f.replace(p+"-0",d+"-"+a),c=b("#"+f+"-group").clone();c.addClass("cloned");if(c.children().first().hasClass("tabular")){c.find(".form-row").not(".empty-form").remove();c.find(".nested-inline-row").remove();template_form=c.find("#"+f+"-empty");new_form=template_form.clone().removeClass(e.emptyCssClass).addClass("dynamic-"+ g);new_form.insertBefore(template_form);c.find("#id_"+g+"-TOTAL_FORMS").val(1);q(c,f,g);f=c.find(".add-row").text();c.find(".add-row").remove();c.find(".tabular.inline-related tbody tr."+g+"-not-nested").tabularFormset({prefix:g,adminStaticPrefix:e.adminStaticPrefix,addText:f,deleteText:e.deleteText});var l=k(g,0,e,!1);l.length&&c.find(".form-row").addClass("no-bottom-border");l.each(function(){border_class=b(this).next()?" no-bottom-border":"";c.find("#"+g+"-empty").before(b('<tr class="nested-inline-row'+ border_class+'">').html(b("<td>",{colspan:"100%"}).html(b(this))))})}else l=k(g,0,e,!0),c.find(".inline-related").not(".empty-form").remove(),template_form=c.find("#"+f+"-empty"),new_form=template_form.clone().removeClass(e.emptyCssClass).addClass("dynamic-"+g),new_form.insertBefore(template_form),c.find("#id_"+f+"-TOTAL_FORMS").val(1),new_form.find(".inline_label").text("#1"),q(c,f,g),f=c.find(".add-row").text(),c.find(".add-row").remove(),c.find(".inline-related").stackedFormset({prefix:g,adminStaticPrefix:e.adminStaticPrefix, addText:f,deleteText:e.deleteText}),l.each(function(){new_form.append(b(this))});n&&(c=c.add(b('<div class="nested-inline-bottom-border">')));h=h.length?h.add(c):c});return h}function q(d,a,e){d.attr("id",d.attr("id").replace(a,e));d.find("*").each(function(){b(this).attr("for")&&b(this).attr("for",b(this).attr("for").replace(a,e));b(this).attr("class")&&b(this).attr("class",b(this).attr("class").replace(a,e));this.id&&(this.id=this.id.replace(a,e));this.name&&(this.name=this.name.replace(a,e))}); prefix_fix=d.find(".inline-related").first();nextIndex=j(e);prefix_fix.hasClass("tabular")&&(prefix_fix=prefix_fix.find(".form-row").first());prefix_fix.attr("id",prefix_fix.attr("id").replace("-empty","-"+nextIndex));prefix_fix.find("*").each(function(){b(this).attr("for")&&b(this).attr("for",b(this).attr("for").replace("__prefix__","0"));b(this).attr("class")&&b(this).attr("class",b(this).attr("class").replace("__prefix__","0"));this.id&&(this.id=this.id.replace("__prefix__","0"));this.name&&(this.name= this.name.replace("__prefix__","0"))})}function j(d){formset_prop=b("#id_"+d+"-TOTAL_FORMS");return!formset_prop.length?0:parseInt(formset_prop.attr("autocomplete","off").val())}function r(d,a){var e=j(d);a?b("#id_"+d+"-TOTAL_FORMS").attr("autocomplete","off").val(parseInt(e)+1):b("#id_"+d+"-TOTAL_FORMS").attr("autocomplete","off").val(parseInt(e)-1)}function m(d){d=b("#id_"+d+"-MAX_FORMS").attr("autocomplete","off").val();return"undefined"==typeof d?"":parseInt(d)}b.fn.formset=function(d){var a= b.extend({},b.fn.formset.defaults,d),e=b(this);d=e.parent();j(a.prefix);e.each(function(){b(this).not("."+a.emptyCssClass).addClass(a.formCssClass)});var n=""===m(a.prefix)||0<m(a.prefix)-j(a.prefix);if(e.length&&n){var h;"TR"==e.attr("tagName")?(e=this.eq(-1).children().length,d.append('<tr class="'+a.addCssClass+'"><td colspan="'+e+'"><a href="javascript:void(0)">'+a.addText+"</a></tr>"),h=d.find("tr:last a")):(e.filter(":last").after('<div class="'+a.addCssClass+'"><a href="javascript:void(0)">'+ a.addText+"</a></div>"),h=e.filter(":last").next().find("a"));h.click(function(d){d.preventDefault();var f=j(a.prefix),e=b("#"+a.prefix+"-empty"),c=e.clone(!0);c.removeClass(a.emptyCssClass).addClass(a.formCssClass).attr("id",a.prefix+"-"+f);c.is("tr")?c.children(":last").append('<div><a class="'+a.deleteCssClass+'" href="javascript:void(0)">'+a.deleteText+"</a></div>"):c.is("ul")||c.is("ol")?c.append('<li><a class="'+a.deleteCssClass+'" href="javascript:void(0)">'+a.deleteText+"</a></li>"):c.children(":first").append('<span><a class="'+ a.deleteCssClass+'" href="javascript:void(0)">'+a.deleteText+"</a></span>");c.find("*").each(function(){var c=a.prefix,d=RegExp("("+c+"-(\\d+|__prefix__))"),c=c+"-"+f;b(this).attr("for")&&b(this).attr("for",b(this).attr("for").replace(d,c));this.id&&(this.id=this.id.replace(d,c));this.name&&(this.name=this.name.replace(d,c))});c.insertBefore(b(e));r(a.prefix,!0);""!==m(a.prefix)&&0>=m(a.prefix)-j(a.prefix)&&h.parent().hide();c.find("a."+a.deleteCssClass).click(function(c){c.preventDefault();c=b(this).parents("."+ a.formCssClass);for(var d=c.parent();c.next().hasClass("nested-inline-row");)c.next().remove();c.remove();r(a.prefix,!1);a.removed&&a.removed(d)});c.is("tr")?(nested_formsets=k(a.prefix,f,a,!1),nested_formsets.length&&c.addClass("no-bottom-border"),nested_formsets.each(function(){border_class=b(this).next()?" no-bottom-border":"";b('<tr class="nested-inline-row'+border_class+'">').html(b("<td>",{colspan:"100%"}).html(b(this))).insertBefore(b(e))})):(nested_formsets=k(a.prefix,f,a,!0),nested_formsets.each(function(){c.append(b(this))})); a.added&&a.added(c);f+=1})}return this};b.fn.formset.defaults={prefix:"form",addText:"add another",deleteText:"remove",addCssClass:"add-row",deleteCssClass:"delete-row",emptyCssClass:"empty-row",formCssClass:"dynamic-form",added:null,removed:null};b.fn.tabularFormset=function(d){var a=b(this),e=function(){row_number=0;b(a.selector).not(".add-row").removeClass("row1 row2").each(function(){b(this).addClass("row"+(row_number%2+1));for(next=b(this).next();next.hasClass("nested-inline-row");)next.addClass("row"+ (row_number%2+1)),next=next.next();row_number+=1})};a.formset({prefix:d.prefix,addText:d.addText,formCssClass:"dynamic-"+d.prefix,deleteCssClass:"inline-deletelink",deleteText:d.deleteText,emptyCssClass:"empty-form",removed:e,added:function(a){a.find(".prepopulated_field").each(function(){var d=b(this).find("input, select, textarea"),e=d.data("dependency_list")||[],f=[];b.each(e,function(b,c){f.push("#"+a.find(".field-"+c).find("input, select, textarea").attr("id"))});f.length&&d.prepopulate(f,d.attr("maxlength"))}); "undefined"!=typeof DateTimeShortcuts&&(b(".datetimeshortcuts").remove(),DateTimeShortcuts.init());"undefined"!=typeof SelectFilter&&(b(".selectfilter").each(function(b,a){var e=a.name.split("-");SelectFilter.init(a.id,e[e.length-1],!1,d.adminStaticPrefix)}),b(".selectfilterstacked").each(function(b,a){var e=a.name.split("-");SelectFilter.init(a.id,e[e.length-1],!0,d.adminStaticPrefix)}));e(a)}});return a};b.fn.stackedFormset=function(d){var a=b(this),e=function(a){a.children(".inline-related").not(".empty-form").children("h3").find(".inline_label").each(function(a){a+= 1;b(this).html(b(this).html().replace(/(#\d+)/g,"#"+a))})};a.formset({prefix:d.prefix,addText:d.addText,formCssClass:"dynamic-"+d.prefix,deleteCssClass:"inline-deletelink",deleteText:d.deleteText,emptyCssClass:"empty-form",removed:e,added:function(a){a.find(".prepopulated_field").each(function(){var d=b(this).find("input, select, textarea"),e=d.data("dependency_list")||[],f=[];b.each(e,function(b,c){f.push("#"+a.find(".form-row .field-"+c).find("input, select, textarea").attr("id"))});f.length&&d.prepopulate(f, d.attr("maxlength"))});"undefined"!=typeof DateTimeShortcuts&&(b(".datetimeshortcuts").remove(),DateTimeShortcuts.init());"undefined"!=typeof SelectFilter&&(b(".selectfilter").each(function(a,b){var e=b.name.split("-");SelectFilter.init(b.id,e[e.length-1],!1,d.adminStaticPrefix)}),b(".selectfilterstacked").each(function(a,b){var e=b.name.split("-");SelectFilter.init(b.id,e[e.length-1],!0,d.adminStaticPrefix)}));e(a.parent())}});return a}})(django.jQuery);
